# 设计文档：增强每周智能体深度洞察报告

## Context
当前报告生成系统的主要问题：
1. 信息提取不充分：论文和资讯的元数据未被充分利用
2. LLM 提示词过于简单：仅提供标题列表，缺少上下文
3. 内容截断过短：核心内容和摘要被过度截断，丢失关键信息

## Goals / Non-Goals

### Goals
- 显著提升报告的信息密度和分析深度
- 充分利用已有数据源中的元数据（作者、机构、发布时间、摘要等）
- 生成更具洞察力的综合分析和建议
- 保持报告可读性和表格格式的整洁性

### Non-Goals
- 不改变报告的基本结构和格式（Markdown 表格）
- 不增加新的数据源或依赖
- 不改变数据读取的核心逻辑（仅优化提取和展示）

## Decisions

### Decision 1: 表格结构扩展策略
**方案**：采用渐进式扩展，在现有表格基础上添加可选列
- 论文表格：从 "功能 | 论文标题 | 核心内容" 扩展为 "功能 | 发布时间 | 论文标题 | 作者/机构 | 核心内容"
- 资讯表格：从 "资讯标题 | 摘要/核心内容" 扩展为 "发布时间 | 资讯标题 | 涉及产品 | 摘要/核心内容"

**理由**：
- 保持向后兼容，现有格式仍然有效
- 新列仅在数据存在时显示，避免空列影响美观
- 列宽通过 Markdown 自动调整，不会影响渲染

**替代方案考虑**：
- 使用折叠区域：会降低可读性，用户需要点击才能看到
- 分离到附录：会增加阅读跳转，降低连贯性

### Decision 2: 核心内容提取策略
**方案**：多层次提取，优先使用 LLM 从丰富上下文提取，回退到基于规则的方法
1. **LLM 模式**（有 API Key 时）：
   - 提供论文的完整元数据（标题、作者、机构、标签、发布时间、排名）
   - 要求 LLM 提取：关键贡献、创新点、应用场景、技术方法
   - 输出格式：结构化的核心内容描述（200-250字符）
2. **规则模式**（无 API Key 时）：
   - 从标题和标签组合生成简短描述
   - 提取关键词并组合成句子

**理由**：
- LLM 模式可以生成更准确和深入的描述
- 规则模式保证在没有 LLM 时仍能生成基础报告
- 批量处理可以减少 API 调用成本

### Decision 3: 摘要信息提取策略
**方案**：优先从 markdown 文件提取完整摘要，而不是从 tags 中提取
1. 扫描所有 markdown 日报文件，提取标题到摘要的映射
2. 在读取 jsonl 时，根据标题匹配摘要
3. 摘要完整展示（最大500字符），不再过度截断

**理由**：
- markdown 文件中的摘要更完整和准确
- 从 tags 提取是临时方案，现在有了更好的数据源
- 500字符的限制可以平衡信息量和可读性

**实施细节**：
- 现有 `readers.py` 中已有 `extract_summaries_from_markdown` 函数
- 需要优化该函数，确保能正确提取所有摘要格式
- 在 `report_writer.py` 中直接使用完整摘要，而不是截断

### Decision 4: 产品分析策略
**方案**：基于关键词匹配和多级提取的产品识别
1. **静态关键词库**：维护常见产品和公司的关键词列表
2. **LLM 增强**（可选）：对重要资讯使用 LLM 提取产品信息
3. **展示策略**：每条资讯显示主要涉及的1-2个产品（避免过长）

**理由**：
- 关键词匹配快速且准确率较高
- LLM 增强可以在复杂情况下提供更准确的提取
- 限制产品数量避免表格列过宽

### Decision 5: LLM 洞察生成策略
**方案**：结构化提示词 + 分层分析要求
1. **提示词结构**：
   ```
   系统角色：资深技术分析员和行业研究员
   
   输入数据（结构化）：
   - 论文详情：标题、作者、机构、标签、发布时间、排名、评分
   - 资讯详情：标题、发布时间、来源、产品、完整摘要、标签
   - SDK详情：仓库、版本、发布时间、主要变更
   
   输出要求：
   - 趋势洞察（短期/中期/长期）
   - 主题聚类（识别跨领域主题）
   - 影响分析（技术/市场/产业）
   - 机会识别
   - 风险评估
   ```

2. **上下文限制**：
   - 论文：最多50篇，包含完整元数据
   - 资讯：最多50条，包含完整摘要
   - SDK：最多30个版本

**理由**：
- 结构化提示词确保 LLM 理解任务要求
- 分层分析要求提供更全面的视角
- 限制上下文大小避免 token 消耗过大

**替代方案考虑**：
- 多轮对话：会增加延迟和成本，不必要
- 单独分析各板块：会失去跨领域洞察，不够综合

## Risks / Trade-offs

### Risk 1: 表格列过多导致可读性下降
**影响**：表格列数从2-3列增加到4-5列，可能在小屏幕上显示不佳
**缓解措施**：
- 使用 Markdown 的自动列宽调整
- 对长文本进行适当截断（但比之前更宽松）
- 考虑在移动端使用响应式表格

### Risk 2: LLM API 调用成本增加
**影响**：增强的提示词会包含更多上下文，增加 token 消耗
**缓解措施**：
- 限制上下文大小（论文50篇、资讯50条、SDK 30个）
- 批量处理减少调用次数
- 提供降级方案（无 LLM 时使用规则提取）

### Risk 3: 摘要提取不准确
**影响**：从 markdown 提取摘要可能因格式变化而失败
**缓解措施**：
- 支持多种 markdown 格式（## 标题 + ### 摘要）
- 提供回退机制（从 tags 提取或生成简短描述）
- 增加日志记录，便于调试

## Migration Plan

### Phase 1: 数据提取增强
1. 优化 `readers.py` 中的摘要提取逻辑
2. 在 `PaperItem` 和 `NewsAggItem` 模型中确保所有字段被正确读取
3. 添加产品提取函数到 `processors.py`

### Phase 2: 论文和资讯表格增强
1. 修改 `report_writer.py` 中的表格生成逻辑
2. 添加新列（发布时间、作者/机构、产品）
3. 调整文本长度限制（核心内容250字符，摘要500字符）

### Phase 3: 综合洞察增强
1. 重写 `build_llm_prompt` 函数，提供结构化上下文
2. 更新 `generate_insights_llm` 函数，要求更深入的分析
3. 测试生成质量，调整提示词

### Phase 4: 测试和优化
1. 在真实数据上测试新报告格式
2. 收集反馈，调整列宽和文本长度
3. 优化 LLM 提示词，确保输出质量

## Open Questions
- 是否需要在报告中添加"数据质量说明"部分，标注哪些信息缺失？
- 产品分析的准确率是否需要人工审核？
- 综合洞察的长度是否需要限制，还是让 LLM 自由发挥？

