# Design: 图片生成集成到报告生成

## Context

当前 `report` 模块生成纯文本 Markdown 报告，包含 Mermaid 图表。用户需要添加图片生成功能，使报告能够包含自定义生成的图片（SVG 或从 PPT 导出），形成图文结合的展示效果。

项目中已有：
- `svg_generator` 模块：可根据自然语言描述生成 SVG 图片
- `PPT` 模块：可根据数据生成带图表的 PowerPoint 文件
- `report` 模块：聚合多个数据源生成 Markdown 报告

## Goals / Non-Goals

### Goals

1. **智能判断**：使用大模型分析报告内容，识别适合生成图片的部分
2. **信息提取**：从报告数据中提取关键信息（如统计数据、趋势、关系等）
3. **图片生成**：使用现有工具（`svg_generator` 或 `PPT`）生成图片
4. **报告集成**：将生成的图片嵌入到 Markdown 报告中

### Non-Goals

1. **不修改现有报告结构**：保持现有报告的基本结构，只在合适位置插入图片
2. **不替换 Mermaid 图表**：保留现有的 Mermaid 图表功能，图片作为补充
3. **不强依赖 PPT**：优先使用 SVG 生成器，PPT 作为可选项

## Decisions

### Decision: 使用 LLM 判断适合生成图片的内容

**理由**：
- 大模型可以理解报告内容的语义，识别哪些部分适合可视化
- 可以根据数据类型（统计数据、流程、关系等）选择合适的图表类型
- 灵活性高，可以适应不同类型的报告内容

**替代方案**：
- 规则引擎：不够灵活，难以适应各种内容类型
- 固定位置插入：缺乏智能化判断

### Decision: 优先使用 SVG 生成器，PPT 作为可选方案

**理由**：
- SVG 更适合在 Markdown 中嵌入和显示
- SVG 生成器更轻量，不需要 PowerPoint 库
- PPT 功能更适合生成复杂的多图表演示文稿

**替代方案**：
- 仅使用 SVG：可能无法满足某些复杂图表需求
- 仅使用 PPT：太重，不适合简单的图片生成需求

### Decision: 图片存储在报告的 `assets/` 子目录

**理由**：
- 保持报告目录结构的清晰
- 便于管理生成的图片文件
- 符合常见的文档组织结构（Markdown + assets）

**替代方案**：
- 内联 SVG：对于复杂 SVG 会增加 Markdown 文件大小
- 外部存储：不利于报告的独立性和可移植性

### Decision: 图片生成作为可选功能

**理由**：
- 需要 `LLM_API_KEY` 配置
- 生成图片会增加处理时间和 API 调用成本
- 允许用户选择是否启用该功能

**实现**：
- 默认禁用，通过配置或命令行参数启用
- 如果 LLM API 不可用，报告正常生成但不包含图片

## Risks / Trade-offs

### 风险

1. **LLM 调用成本**：生成图片需要多次 LLM 调用，增加 API 成本
   - **缓解**：提供开关，允许用户禁用图片生成
   - **缓解**：限制图片生成数量（例如最多 5 张）

2. **生成质量不稳定**：LLM 生成的图片质量可能不一致
   - **缓解**：提供图片验证机制，失败时记录日志但不中断报告生成
   - **缓解**：允许用户手动调整或替换生成的图片

3. **性能影响**：图片生成会增加报告生成时间
   - **缓解**：异步生成或并行处理
   - **缓解**：提供缓存机制（相同内容的报告复用已有图片）

### 权衡

- **灵活性 vs 性能**：使用 LLM 判断提供灵活性，但增加了处理时间
- **SVG vs PPT**：SVG 更轻量但可能无法满足所有需求，PPT 功能更强大但依赖更重

## Migration Plan

1. **阶段 1**：添加图片生成功能，默认禁用
2. **阶段 2**：在报告中添加 `assets/` 目录结构
3. **阶段 3**：集成 `svg_generator` 模块
4. **阶段 4**：添加 LLM 判断逻辑
5. **阶段 5**：可选集成 PPT 模块功能

**向后兼容**：
- 默认禁用图片生成，不影响现有报告生成流程
- 如果图片生成失败，报告仍正常生成（降级处理）

## Open Questions

1. **图片类型判断**：LLM 如何判断适合生成哪些类型的图片？
   - 需要定义清晰的判断标准和输出格式（JSON）

2. **图片数量限制**：每个报告最多生成多少张图片？
   - 建议：最多 3-5 张，避免过度生成

3. **图片缓存策略**：相同内容的报告是否需要复用已有图片？
   - 可以考虑基于内容哈希进行缓存

4. **PPT 集成方式**：如果使用 PPT 生成图表，如何导出为图片？
   - 可能需要将 PPT 转换为图片（PNG/SVG）再嵌入 Markdown

